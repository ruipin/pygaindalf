# 🧙‍♂️ Gaindalf the Red, White, and Blue 🇬🇧 <!-- omit in toc -->

> *You shall not pass... until you have paid Capital Gains Tax.*

`pygaindalf` is a Python-powered framework for automating the dark art of **UK Capital Gains Tax (CGT)** calculations.

Whether you're juggling broker CSVs, taming forex conversions, deciphering ERI reports, or wrestling with S104 incantations, this project aims to be your trusty wand. Configure your spellbook, summon your data, and let 🧙‍♂️ *Gaindalf the Red, White, and Blue* 🇬🇧 do the rest.

[![Static Badge](https://img.shields.io/badge/-ruipin%2Fpygaindalf-grey?logo=github)](https://github.com/ruipin/pygaindalf)
[![GitHub last commit](https://img.shields.io/github/last-commit/ruipin/pygaindalf/main)](https://github.com/ruipin/pygaindalf/commits/main/)
[![License](https://img.shields.io/github/license/ruipin/pygaindalf)](https://github.com/ruipin/pygaindalf/blob/main/LICENSE)
[![Version (latest)](https://img.shields.io/github/v/release/ruipin/pygaindalf)](https://github.com/ruipin/pygaindalf/releases/latest)
[![GitHub issues](https://img.shields.io/github/issues-raw/ruipin/pygaindalf)](https://github.com/ruipin/pygaindalf/issues)
[![Ko-fi](https://img.shields.io/badge/-buy%20me%20a%20coffee-%23FF5E5B?logo=Ko-fi&logoColor=white)](https://ko-fi.com/ruipin)


- [1. ⚠️ Disclaimer](#1-️-disclaimer)
- [2. ✨ Status](#2--status)
  - [2.1. Goals](#21-goals)
  - [2.2. Philosophy](#22-philosophy)
- [3. 🚀 Installation](#3--installation)
  - [3.1. Requirements](#31-requirements)
  - [3.2. Installing python dependencies](#32-installing-python-dependencies)
  - [3.3. Environment](#33-environment)
- [4. 🧪 Running Tests](#4--running-tests)
  - [4.1. Filtering Tests](#41-filtering-tests)
- [5. 📜 License](#5--license)

---


## 1. ⚠️ Disclaimer

**Use `pygaindalf` at your own risk.**

This software is provided *as-is* with **no guarantees or warranties**. You alone are responsible for ensuring the accuracy and completeness of any reports or filings you make to HMRC or other authorities - whether generated by `pygaindalf` or otherwise.

Neither the authors nor distributors accept any liability for any data loss, inaccuracies, or operational failures - even if warned of potential issues.

For full details, see Sections 15 through 17 of the [GPLv3 license](https://github.com/ruipin/pygaindalf/blob/main/LICENSE).

## 2. ✨ Status

> *"All we have to decide is what to do with the time that is given us."* - Gandalf

`pygaindalf` is currently a work-in-progress, a glimmer in the wizard's eye, and **not yet ready for production use**.

Expect rapid development, breaking changes, and ongoing improvements. This README will evolve as the project grows.

### 2.1. Goals

`pygaindalf` aims to:

- 🧾 **Import** data from multiple brokers, CSVs, APIs, and other mystical sources.
- 💱 **Convert** all values to GBP using trusted oracles (HMRC spot rates, forex APIs, etc.).
- 📚 **Apply complex CGT rules**: S104 matching, bed & breakfast, ERI adjustments, and other sorcery.
- 📤 **Export** results to `.yaml`, `.json`, `.csv`, `.xls`, `.txt` and others, as well as formats accepted by tools like [cgtcalculator.com](https://cgtcalculator.com).
- 💾 **Save & restore** the full calculation state between tax years - no need to re-slay old dragons.
- 📈 **Track** your holdings over time, across accounts, currencies, and securities.
- 🧩 **Support multiple calculation engines and strategies** - e.g., different rounding modes or FIFO vs HMRC rules.
- ⚙️ **Be composable** - built from small, swappable, and testable components you can easily extend.
- 🔍 **Be transparent** - every step traceable, every transformation explainable.
- 🇬🇧 Focus firmly on **UK-specific tax laws** and HMRC guidelines.

### 2.2. Philosophy

`pygaindalf` intends to make CGT automation:

- **Declarative**: Sane, declarative YAML configs instead of tangled scripts or spreadsheet rage.
- **Modular**: Small, reusable, easily tested building blocks.
- **Extensible**: Plug in your own magic to tailor calculations to your unique needs.
- **Transparent**: Traceable, auditable calculations for peace of mind.

---

## 3. 🚀 Installation

### 3.1. Requirements

- Python 3.13 or later
- [uv](https://github.com/astral-sh/uv) (fast Python package installer)
- [graphviz](https://graphviz.org) (for rendering class inheritance diagrams in the documentation)

### 3.2. Installing python dependencies

To install the required python dependencies, run:

```sh
uv sync
```

This will use `pyproject.toml` and `uv.lock` to install all dependencies.

### 3.3. Environment

You can either:

- Activate a virtual environment (recommended):
  ```sh
  source .venv/bin/activate
  ```

- Or, skip the venv and prefix commands with `uv run`, e.g.:
  ```sh
  uv run pygaindalf.py
  uv run pytest
  ```

---

## 4. 🧪 Running Tests

To run the test suite using pytest, simply execute:

```sh
uv run pytest
```

This will discover and run all tests in the `test/` directory.

### 4.1. Filtering Tests

You can filter which tests to run using pytest's `-k` and `-m` options:

- To run only tests with a specific mark (e.g., `@pytest.mark.logging`):
  ```sh
  uv run pytest -m logging
  ```
- To run tests whose names match a substring or expression:
  ```sh
  uv run pytest -k "expression"
  ```

See the [pytest documentation](https://docs.pytest.org/en/stable/how-to/mark.html) for more details.

---

## 5. 📜 License

`pygaindalf` is licensed under the [GNU General Public License v3.0 (GPL-3.0)](https://github.com/ruipin/pygaindalf/blob/main/LICENSE) or later.

This means you are free to use, modify, and distribute the software under the terms of the GPLv3, which ensures that the project and any derivatives remain free and open.

---

Happy calculating, and may your gains be ever in your favour! 🧙‍♂️🚀📈